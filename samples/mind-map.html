<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>det-mind-map</title>
    <style type="text/css">
        .painter {
            position: relative;
        }
        .selectInput {
            position: absolute;
        }
        .colorPicker-picker {
            display: inline-block;
        }
    </style>
    <link rel="stylesheet" href="colorPicker.css">
</head>
<body>
<div class="toolbar">
    <button class="edit" onclick="editSelection()">编辑</button>
    <button onclick="removeSeletion()">删除主题</button>
    <button onclick="appendSelectionBrother()">主题</button>
    <button onclick="appendSelectionChild()">子主题</button>
    <button onclick="undo()">Undo</button>
    <button onclick="redo()">Redo</button>
    <input id="strokeColor" type="text" name="strokeColor" value="#fff" />
    <button>线条颜色</button>

</div>
<div class="painter">
    <svg id="diagram" width="800" height="600"></svg>
</div>
<p>
</p>
</body>
<script src="jquery.js"></script>
<script src="jquery.colorPicker.js"></script>
<script src="../det/src/det.js"></script>
<script src="../det/src/toolkit.js"></script>
<script src="../det/src/events.js"></script>
<script src="../det/src/model.js"></script>
<script src="../det/src/stack.js"></script>
<script src="../det/src/ctrl/base.js"></script>
<script src="../det/src/ctrl/graph.js"></script>
<script src="../det/src/ctrl/diagram.js"></script>
<script src="../det/src/ctrl/link.js"></script>
<script src="../det/src/feature/base.js"></script>
<script src="../det/src/feature/drag.js"></script>
<script src="../det-mind-map/src/plugin.js"></script>
<script src="../det-mind-map/src/cmd/append.js"></script>
<script src="../det-mind-map/src/cmd/edit.js"></script>
<script src="../det-mind-map/src/cmd/setLineColor.js"></script>
<script src="../det-mind-map/src/cmd/remove.js"></script>
<script src="../det-mind-map/src/ctrl/diagram.js"></script>
<script src="../det-mind-map/src/ctrl/node.js"></script>
<script src="../det-mind-map/src/model/diagram.js"></script>
<script src="../det-mind-map/src/model/node.js"></script>
<script src="../det-mind-map/src/feature/layout.js"></script>
<script src="../det-mind-map/src/feature/select.js"></script>
<script src="../bower_components/Snap.svg/dist/snap.svg.js"></script>
<script>
    var toolkit = det.create(), diagram, diagramCtrl;
    toolkit.plugin(detMindMap);
    diagram = new detMindMap.MindDiagram({
        title : '我的图',
        root : {
            text : '中心主题',
            rectAttr : {
                fill : '#99ccff',
                stroke : "#979b9e",
                strokeWidth : '1',
            },
            textAttr : {
                'font-size' : '25px'
            },
            nodes : [{
                text : '子主题1',
                rectAttr : {
                    fill : '#fff',
                    stroke : "#ffcc00",
                    strokeWidth : '1',
                },
                lineAttr : {
                    stroke : '#ffcc00',
                    strokeWidth : '2',
                    fill : '#ffcc00'
                },
                nodes : [{
                    text : '子主题1-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : '#ffcc00',
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题1-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : '#ffcc00',
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题1-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : '#ffcc00',
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题1-4',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : '#ffcc00',
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题1-5',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : '#ffcc00',
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题1-6',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : '#ffcc00',
                        strokeWidth : '2'
                    }
                }]
            }, {
                text : '子主题2',
                rectAttr : {
                    fill : '#fff',
                    stroke : "#8989FF",
                    strokeWidth : '1',
                },
                lineAttr : {
                    stroke : '#8989FF',
                    strokeWidth : '2',
                    fill : '#8989FF'
                }
            }, {
                text : '子主题3',
                rectAttr : {
                    fill : '#fff',
                    stroke : "#FF0022",
                    strokeWidth : '1',
                },
                lineAttr : {
                    stroke : '#FF0022',
                    strokeWidth : '2',
                    fill : '#FF0022'
                }
            }, {
                text : '子主题4',
                rectAttr : {
                    fill : '#fff',
                    stroke : "#00cc00",
                    strokeWidth : '1',
                },
                lineAttr : {
                    stroke : "#00cc00",
                    strokeWidth : '2',
                    fill : "#00cc00"
                },
                nodes : [{
                    text : '子主题4-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00cc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#00cc00",
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题4-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00cc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#00cc00",
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题4-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00cc00",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#00cc00",
                        strokeWidth : '2'
                    }
                }]
            }, {
                text : '子主题5',
                rectAttr : {
                    fill : '#fff',
                    stroke : "#ff00ff",
                    strokeWidth : '1',
                },
                lineAttr : {
                    stroke : "#ff00ff",
                    strokeWidth : '2',
                    fill : "#ff00ff"
                },
                nodes : [{
                    text : '子主题5-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ff00ff",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#ff00ff",
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题5-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ff00ff",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#ff00ff",
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题5-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ff00ff",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#ff00ff",
                        strokeWidth : '2'
                    }
                }]
            }, {
                text : '子主题6',
                rectAttr : {
                    fill : '#fff',
                    stroke : "#00ccff",
                    strokeWidth : '1',
                },
                lineAttr : {
                    stroke : "#00ccff",
                    strokeWidth : '2',
                    fill : "#00ccff"
                },
                nodes : [{
                    text : '子主题6-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00ccff",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#00ccff",
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题6-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00ccff",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#00ccff",
                        strokeWidth : '2'
                    }
                }, {
                    text : '子主题6-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00ccff",
                        strokeWidth : '1',
                    },
                    lineAttr : {
                        stroke : "#00ccff",
                        strokeWidth : '2'
                    }
                }]
            }]
        }
    });
    diagramCtrl = toolkit.render(document.getElementById('diagram'), diagram);

    function undo() {
        diagramCtrl.getCommandStack().undo();
    }

    function redo() {
        diagramCtrl.getCommandStack().redo();
    }

    function removeSeletion() {
        var selection = diagramCtrl.getSelection(),
            rootCtrl = diagramCtrl.getRootCtrl();
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection === rootCtrl) {
            return;
        }
        selection.execute(
            new detMindMap.RemoveCommand(
                selection.getParent().getModel(),
                selection.getModel()));
    }

    function editSelection() {
        var left, top, width, height,
            selection = diagramCtrl.getSelection(),
            rootCtrl = diagramCtrl.getRootCtrl();
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        function setText(evt) {
            selection.execute(
                new detMindMap.EditCommand(
                    selection.getModel(), 'text', inputEl.val()));
            inputEl.hide();
        }

        console.log(selection.rect, selection.text);
        left = selection.rect.getBBox().x;
        top = selection.rect.getBBox().y;
        width = selection.rect.getBBox().width;
        height = selection.rect.getBBox().height;

        var inputEl = $('<input type="text" />');
        inputEl.appendTo($('.painter'));
        inputEl.css('left', left + 4);
        inputEl.css('top', top);
        inputEl.css('width', width - 8);
        inputEl.css('height', height - 8);
        inputEl.addClass('selectInput');
        inputEl.val(selection.getModel().get('text'));

        inputEl.focus();
        inputEl.on('keydown', function (evt) {
            if (evt.keyCode && evt.keyCode === 13) {
                setText();
            }
        });
        inputEl.on('blur', setText);

    }

    function appendChild(node) {
        var newModel = new MindNode({
            text : '子主题',
            rectAttr : {
                fill : '#fff',
                stroke : "#00ccff",
                strokeWidth : '1',
            },
            lineAttr : {
                stroke : "#00ccff",
                strokeWidth : '2'
            }
        });
        newModel.set('rectAttr', node.getModel().get('rectAttr'));
        newModel.set('lineAttr', node.getModel().get('lineAttr'));
        node.execute(
            new detMindMap.AppendCommand(
                node.getModel(), newModel));
    }

    function appendSelectionChild() {
        var selection = diagramCtrl.getSelection();
        if (selection.length == 0) {
            return;
        }
        appendChild(selection[0]);
    }

    function appendSelectionBrother() {
        var selection = diagramCtrl.getSelection();
        if (selection.length == 0) {
            return;
        }
        appendChild(selection[0].getParent());
    }

    function setSelectionLineColor(newColor) {
        var selection = diagramCtrl.getSelection();
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection.getModel().get('lineAttr').stroke === newColor) {
            return;
        }
        selection.execute(new detMindMap.SetLineColorCommand(
            selection.getModel(), newColor));
    }
    diagramCtrl.bind('select', function (e) {
        var model = e.target.getModel();
        //e.target 表示被选择的 ctrl， e.currentTarget 表示绑定事件的 ctrl
        console.log(e.target.getModel().data);
        if (e.target.getModel().data.root) {
            return;
        }
        $('#strokeColor').val(e.target.getModel().get('lineAttr').stroke);
        $('#strokeColor').change();
    });

    $('#strokeColor').colorPicker({
        onColorChange : function (id, newColor) {
            setSelectionLineColor(newColor);
        }
    });
</script>
</html>
