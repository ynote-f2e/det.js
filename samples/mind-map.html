<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>det-mind-map</title>
    <link rel="stylesheet" href="colorPicker.css">
    <style type="text/css">
        html,body,p,span,div {margin: 0; padding: 0;}
        html,body {
            font-size: 14px;
        }
        #mindMap {
            width: 800px;
        }
        .painter {
            position: relative;
            margin: 35px 0;
        }
        .toolbar {
            position: fixed;
            top: 0;
            z-index: 10;
            padding: 5px 0;
            width: 800px;
            font-size: 0;
            border-bottom: 1px solid #ddd;
            background: #f2f2f2;
        }
        .toolbar .toolbar-btn {
            position: relative;
            display: inline-block;
            margin: 0px 5px;
            padding: 2px;
            border-radius: 3px;
            vertical-align: top;
        }
        .toolbar .toolbar-btn:hover,
        .toolbar .toolbar-btn.selected {
            background-color: #d5e1f2;
            cursor: pointer;
        }
        .toolbar .icon {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
            font-size: 12px;
            background: url(sprite.png) no-repeat;
        }
        .toolbar .text {
            display: inline-block;
            margin: 0px 5px;
            padding: 0 5px;
            line-height: 20px;
            font-size: 12px;
            font-family: '微软雅黑';
            height: 20px;
        }
        .toolbar .dropdown {
            width: 10px;
            background-position: -3px -40px;
        }
        .toolbar .undo {
            background-position: 0px -20px;
        }
        .toolbar .redo {
            background-position: -20px 0px;
        }
        .toolbar .remove {
            background-position: 0px -500px;
        }
        .toolbar .bold {
            background-position: -20px -40px;
        }
        .toolbar .italic {
            background-position: -0px -60px;
        }
        .toolbar .font-color {
            background-position: -0px -80px;
        }
        .toolbar .line-color {
            background-position: -0px -160px;
        }
        .toolbar .fill-color {
            background-position: -20px -140px;
        }
        div.colorPicker-picker {
            position: absolute;
            left: 2px;
            bottom: 2px;
            height: 3px;
            width: 20px;
            border: none;
            color: #bbb;
        }
        .selectInput {
            position: absolute;
            margin: 3px 1px;
            border: none;
            min-height: 18px;
        }
        .colorPicker-picker {
            display: inline-block;
        }
        .context-menu {
            position: absolute;
            z-index: 9999;
            font-size: 12px;
            list-style: none;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            background-clip: padding-box;
            font-family: "Microsoft Yahei";
            display: none;
            padding: 0;
            min-width: 70px;
            background: #fff;
            border-radius: 5px;
        }
        .context-menu .menu-item {
            display: block;
            padding: 0;
            min-height: 20px;
            padding: 5px 5px;
            text-align: center;
            line-height: 20px;
            border-radius: 3px;
        }
        .context-menu .menu-item:hover {
            background: #E2D1F7;
        }
    </style>
</head>
<body>
    <div id="mindMap">
        <div class="toolbar">
            <div class="toolbar-btn btn-undo" title="撤销(CTRL+Z)" onclick="undo()">
                <i class="icon undo"></i>
            </div>
            <div class="toolbar-btn btn-redo" title="重做(CTRL+Y)" onclick="redo()">
                <i class="icon redo"></i>
            </div>
            <div class="toolbar-btn btn-remove" title="删除主题(Del)" onclick="removeSeletion()">
                <i class="icon remove"></i>
            </div>
            <div class="toolbar-btn btn-bold" title="粗体(CTRL+B)" onclick="changeSelectionFontWeight()">
                <i class="icon bold"></i>
            </div>
            <div class="toolbar-btn btn-italic" title="斜体(CTRL+I)" onclick="changeSelectionFontStyle()">
                <i class="icon italic"></i>
            </div>
            <div class="toolbar-btn btn-font-color" title="文字颜色">
                <i class="icon font-color">
                </i>
                <input id="fontColor" type="text" name="fontColor" value="#000" />
                <i class="icon dropdown"></i>
            </div>
            <div class="toolbar-btn btn-line-color" title="线条颜色">
                <i class="icon line-color">
                </i>
                <input id="lineColor" type="text" name="lineColor" value="#fff" />
                <i class="icon dropdown"></i>
            </div>
            <div class="toolbar-btn btn-fill-color" title="填充颜色">
                <i class="icon fill-color">
                </i>
                <input id="rectBackground" type="text" name="rectBackground" value="#fff" />
                <i class="icon dropdown"></i>
            </div>
            <div class="toolbar-btn btn-insert-bro" title="(Enter)" onclick="appendSelectionBrother()">
                <span class="text">插入主题</span>
            </div>
            <div class="toolbar-btn btn-insert-son" title="(Ins/Tab)" onclick="appendSelectionChild()">
                <span class="text">插入子主题</span>
            </div>
        </div>
        <div class="painter">
            <svg id="diagram" width="800" height="600"></svg>
        </div>
    </div>
</body>
<script src="jquery.js"></script>
<script src="jquery.colorPicker.js"></script>
<script src="../det/src/det.js"></script>
<script src="../det/src/toolkit.js"></script>
<script src="../det/src/events.js"></script>
<script src="../det/src/model.js"></script>
<script src="../det/src/stack.js"></script>
<script src="../det/src/ctrl/base.js"></script>
<script src="../det/src/ctrl/graph.js"></script>
<script src="../det/src/ctrl/diagram.js"></script>
<script src="../det/src/ctrl/link.js"></script>
<script src="../det/src/feature/base.js"></script>
<script src="../det/src/feature/drag.js"></script>
<script src="../det/src/util/box.js"></script>
<script src="../det/src/cmd/batch.js"></script>

<script src="../det-mind-map/src/plugin.js"></script>
<script src="../det-mind-map/src/cmd/append.js"></script>
<script src="../det-mind-map/src/cmd/edit.js"></script>
<script src="../det-mind-map/src/cmd/setLineColor.js"></script>
<script src="../det-mind-map/src/cmd/setTextAttr.js"></script>
<script src="../det-mind-map/src/cmd/setBackgroundColor.js"></script>
<script src="../det-mind-map/src/cmd/remove.js"></script>
<script src="../det-mind-map/src/cmd/move.js"></script>
<script src="../det-mind-map/src/ctrl/diagram.js"></script>
<script src="../det-mind-map/src/ctrl/node.js"></script>
<script src="../det-mind-map/src/model/diagram.js"></script>
<script src="../det-mind-map/src/model/node.js"></script>
<script src="../det-mind-map/src/feature/layout.js"></script>
<script src="../det-mind-map/src/feature/select.js"></script>
<script src="../det-mind-map/src/feature/move.js"></script>
<script src="../det-mind-map/src/style/style.js"></script>
<script src="../det-mind-map/src/style/rect/normal.js"></script>
<script src="../det-mind-map/src/style/rect/underline.js"></script>
<script src="../det-mind-map/src/style/line/normal.js"></script>
<script src="../det-mind-map/src/style/line/polyline.js"></script>

<script src="../bower_components/Snap.svg/dist/snap.svg.js"></script>
<script>

    var contextmenuTemp = '<ul class="context-menu">' +
        '<li class="menu-item" onclick="appendSelectionChild()">插入</li>' +
        '<li class="menu-item" onclick="editSelection()">编辑</li>' +
        '<li class="menu-item" onclick="removeSeletion()">删除</li>' +
        '</ul>';
    var menu = $(contextmenuTemp);
    menu.appendTo($('.painter'));

    var colorBoxs = ['FF0000', 'FF9900', '00CCFF', '3366FF', 'FF00FF', '00FF00', '00FFFF', 'FFCC00', 'FF99CC', '800080'];
    var toolkit = det.create(), diagram, diagramCtrl;
    toolkit.plugin(detMindMap);
    diagram = new detMindMap.MindDiagram({
        title : '我的图',
        root : {
            text : '中心主题',
            rectAttr : {
                fill : '#99ccff',
                stroke : "#979b9e",
                strokeWidth : '2',
            },
            textAttr : {
                'font-size' : '25px',
                'font-weight' : 'bold'
            },
            nodes : [{
                text : '子主题1',
                textAttr : {
                    'font-size' : '16px'
                },
                rectAttr : {
                    fill : '#fff',
                    stroke : "#ffcc00",
                    strokeWidth : '2',
                },
                lineAttr : {
                    stroke : '#ffcc00',
                    strokeWidth : '2',
                    fill : '#ffcc00'
                },
                nodes : [{
                    text : '子主题1-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00"
                    },
                    lineAttr : {
                        stroke : '#ffcc00'
                    }
                }, {
                    text : '子主题1-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00"
                    },
                    lineAttr : {
                        stroke : '#ffcc00'
                    }
                }, {
                    text : '子主题1-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00"
                    },
                    lineAttr : {
                        stroke : '#ffcc00'
                    }
                }, {
                    text : '子主题1-4',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00"
                    },
                    lineAttr : {
                        stroke : '#ffcc00'
                    }
                }, {
                    text : '子主题1-5',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00"
                    },
                    lineAttr : {
                        stroke : '#ffcc00'
                    }
                }, {
                    text : '子主题1-6',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ffcc00"
                    },
                    lineAttr : {
                        stroke : '#ffcc00'
                    }
                }]
            }, {
                text : '子主题2',
                textAttr : {
                    'font-size' : '16px'
                },
                rectAttr : {
                    fill : '#fff',
                    stroke : "#8989FF",
                    strokeWidth : '2',
                },
                lineAttr : {
                    stroke : '#8989FF',
                    fill : '#8989FF'
                }
            }, {
                text : '子主题3',
                textAttr : {
                    'font-size' : '16px'
                },
                rectAttr : {
                    fill : '#fff',
                    stroke : "#FF0022",
                    strokeWidth : '2',
                },
                lineAttr : {
                    stroke : '#FF0022',
                    fill : '#FF0022'
                }
            }, {
                text : '子主题4',
                textAttr : {
                    'font-size' : '16px'
                },
                rectAttr : {
                    fill : '#fff',
                    stroke : "#00cc00",
                    strokeWidth : '1',
                },
                lineAttr : {
                    stroke : "#00cc00",
                    fill : "#00cc00"
                },
                nodes : [{
                    text : '子主题4-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00cc00"
                    },
                    lineAttr : {
                        stroke : "#00cc00"
                    }
                }, {
                    text : '子主题4-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00cc00"
                    },
                    lineAttr : {
                        stroke : "#00cc00"
                    }
                }, {
                    text : '子主题4-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00cc00"
                    },
                    lineAttr : {
                        stroke : "#00cc00"
                    }
                }]
            }, {
                text : '子主题5',
                textAttr : {
                    'font-size' : '16px'
                },
                rectAttr : {
                    fill : '#fff',
                    stroke : "#ff00ff",
                    strokeWidth : '2',
                },
                lineAttr : {
                    stroke : "#ff00ff",
                    fill : "#ff00ff"
                },
                nodes : [{
                    text : '子主题5-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ff00ff"
                    },
                    lineAttr : {
                        stroke : "#ff00ff"
                    }
                }, {
                    text : '子主题5-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ff00ff"
                    },
                    lineAttr : {
                        stroke : "#ff00ff"
                    }
                }, {
                    text : '子主题5-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#ff00ff"
                    },
                    lineAttr : {
                        stroke : "#ff00ff"
                    }
                }]
            }, {
                text : '子主题6',
                textAttr : {
                    'font-size' : '16px'
                },
                rectAttr : {
                    fill : '#fff',
                    stroke : "#00ccff",
                    strokeWidth : '2',
                },
                lineAttr : {
                    stroke : "#00ccff",
                    fill : "#00ccff"
                },
                nodes : [{
                    text : '子主题6-1',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00ccff"
                    },
                    lineAttr : {
                        stroke : "#00ccff"
                    }
                }, {
                    text : '子主题6-2',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00ccff"
                    },
                    lineAttr : {
                        stroke : "#00ccff"
                    }
                }, {
                    text : '子主题6-3',
                    rectAttr : {
                        fill : '#fff',
                        stroke : "#00ccff"
                    },
                    lineAttr : {
                        stroke : "#00ccff"
                    }
                }]
            }]
        }
    });
    diagramCtrl = toolkit.render(document.getElementById('diagram'), diagram);

    function undo() {
        diagramCtrl.undo();
    }

    function redo() {
        diagramCtrl.redo();
    }

    function removeSeletion() {
        var selection = diagramCtrl.getSelection(),
            rootCtrl = diagramCtrl.getRootCtrl();
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection === rootCtrl) {
            return;
        }
        var parent = selection.getParent();
        var children = parent.getChildren();
        var index = children.indexOf(selection);
        selection.execute(
            new detMindMap.RemoveCommand(
                selection.getParent().getModel(),
                selection.getModel()));

        var model = parent.getModel();
        if (children.length) {
            while (!children[index]) {
                index--;
            }
            children[index].select();
        } else {
            parent.select();
        }
    }

    function editSelection() {
        var left, top, width, height,
            selection = diagramCtrl.getSelection(),
            rootCtrl = diagramCtrl.getRootCtrl();
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        function setText(evt) {
            selection.execute(
                new detMindMap.EditCommand(
                    selection.getModel(), 'text', inputEl.val()));
            inputEl.remove();
        }

        console.log(selection.rect, selection.text);
        left = selection.rect.getBBox().x;
        top = selection.rect.getBBox().y;
        width = selection.rect.getBBox().width;
        height = selection.rect.getBBox().height;

        var inputEl = $('<input type="text" />');
        inputEl.appendTo($('.painter'));
        inputEl.css('left', left + 4);
        if (selection.isRoot() || selection.isSecond()){
            inputEl.css('top', top);
        } else {
            inputEl.css('top', top - 4);
        }
        inputEl.css('width', width - 4);
        inputEl.css('height', height - 8);
        inputEl.addClass('selectInput');
        inputEl.val(selection.getModel().get('text'));

        inputEl.focus();
        inputEl.on('keydown', function (evt) {
            evt.stopPropagation();
            if (evt.keyCode && evt.keyCode === 13) {
                setText();
            }
        });
        inputEl.on('blur', setText);

    }

    function getColorBox() {
        return '#' + 
            colorBoxs[parseInt(Math.random() * 10, 10)];
    }
    function appendChild(node) {
        var color = getColorBox();
        var newModel = new MindNode({
            text : '子主题',
            rectAttr : {
                fill : '#fff',
                stroke : color,
                strokeWidth : '2',
            },
            lineAttr : {
                fill : color,
                stroke : color,
                strokeWidth : '2'
            }
        });
        if (node.isRoot()) {
            newModel.setTextAttr('font-size', '16px');
        } else {
            newModel.set('rectAttr', node.getModel().get('rectAttr'));
            newModel.set('lineAttr', node.getModel().get('lineAttr'));
        }
        node.execute(
            new detMindMap.AppendCommand(
                node.getModel(), newModel));
    }

    function appendSelectionChild() {
        var selection = diagramCtrl.getSelection();
        if (selection.length == 0) {
            return;
        }
        appendChild(selection[0]);
        //select new subject
        selection[0].deselect();
        var children = selection[0].getChildren();
        children[children.length - 1].select();
    }

    function appendSelectionBrother() {
        var selection = diagramCtrl.getSelection(),
            rootCtrl = diagramCtrl.getRootCtrl();
        if (selection.length == 0) {
            return;
        }
        if (selection[0] === rootCtrl) {
            return;
        }
        appendChild(selection[0].getParent());
        //select new subject
        selection[0].deselect();
        var children = selection[0].getParent().getChildren();
        children[children.length - 1].select();
    }

    function changeSelectionFontWeight() {
        var selection = diagramCtrl.getSelection(),
            commands, fontWeight;
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection.getModel().data.root) {
            return;
        }
        fontWeight = selection.getModel().getTextAttr('font-weight');
        if (!fontWeight || fontWeight === 'normal') {
            fontWeight = 'bold';
            $('.btn-bold').addClass('selected');
        } else {
            fontWeight = null;
            $('.btn-bold').removeClass('selected');
        }
        commands = new detMindMap.SetTextAttrCommand(selection.getModel(),
            'font-weight', fontWeight);
        selection.execute(commands);
    }

    function changeSelectionFontStyle() {
        var selection = diagramCtrl.getSelection(),
            commands, fontStyle;
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection.getModel().data.root) {
            return;
        }
        fontStyle = selection.getModel().getTextAttr('font-style');
        if (!fontStyle || fontStyle === 'normal') {
            fontStyle = 'italic';
            $('.btn-italic').addClass('selected');
        } else {
            fontStyle = null;
            $('.btn-italic').removeClass('selected');
        }
        commands = new detMindMap.SetTextAttrCommand(selection.getModel(),
            'font-style', fontStyle);
        selection.execute(commands);

    }
    function setSelectionFontColor(newColor) {
        var selection = diagramCtrl.getSelection(),
            commands;
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection.getModel().data.root) {
            return;
        }
        commands = new detMindMap.SetTextAttrCommand(selection.getModel(),
            'fill', newColor);
        selection.execute(commands);
    }

    function setSelectionLineColor(newColor) {
        var selection = diagramCtrl.getSelection(),
            commands;
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection.getModel().data.root) {
            return;
        }
        if (!selection.getModel().getLineAttr('stroke') ||
                selection.getModel().getLineAttr('stroke') === newColor) {
            return;
        }
        commands = [new detMindMap.SetLineColorCommand(
                selection.getModel(), newColor)];
        selection.getChildren().forEach(function addCommand(child) {
            commands.push(new detMindMap.SetLineColorCommand(
                child.getModel(), newColor));
            child.getChildren().forEach(addCommand);
        });
        selection.execute(new det.BatchCommand(commands));
    }

    function setSelectionBackgroundColor(newColor) {
        var selection = diagramCtrl.getSelection(),
            commands;
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        if (selection.getModel().data.root) {
            return;
        }
        selection.execute(new detMindMap.SetBackgroundColorCommand(
            selection.getModel(), newColor));
    }

    function showSelectionContextMenu(x, y) {
        var selection = diagramCtrl.getSelection(),
            commands;
        if (selection.length == 0) {
            return;
        }
        selection = selection[0];
        $('.context-menu').css('display', 'inline-block');
        $('.context-menu').css('left', x);
        if (y + $('.context-menu').height() > $('.painter').height()) {
            $('.context-menu').css('top', y - $('.context-menu').height());
        } else {
            $('.context-menu').css('top', y);
        }
        $('.context-menu').blur(function () {
            $(this).hide();
        });
    }

    function clickLine(e) {
        if(e && e.hasOwnProperty('originalEvent')) {
            $('.btn-line-color .colorPicker-picker').click();
        }
    }
    function clickFontColor(e) {
        if(e && e.hasOwnProperty('originalEvent')) {
            $('.btn-font-color .colorPicker-picker').click();
        }
    }
    function clickBackground(e) {
        if(e && e.hasOwnProperty('originalEvent')) { 
            $('.btn-fill-color .colorPicker-picker').click();
        }
    }

    function calcMenuX(x) {
        return x - $('.painter').offset().left;
    }
    function calcMenuY(y) {
        return y - $('.painter').offset().top;
    }
    diagramCtrl.bind('select', function (e) {
        var model = e.target.getModel();
        //e.target 表示被选择的 ctrl， e.currentTarget 表示绑定事件的 ctrl
        if (model.data.root) {
            return;
        }
        if (model.getTextAttr('fill')) {
            $('#fontColor').val(model.getTextAttr('fill'));
            $('#fontColor').change();
        }
        if (model.getTextAttr('font-weight')) {
            $('.btn-bold').addClass('selected');
        } else {
            $('.btn-bold').removeClass('selected');
        }
        if (model.getTextAttr('font-style')) {
            $('.btn-italic').addClass('selected');
        } else {
            $('.btn-italic').removeClass('selected');
        }
        $('#lineColor').val(model.getLineAttr('stroke'));
        $('#lineColor').change();

        $('#rectBackground').val(model.getRectAttr('fill'));
        $('#rectBackground').change();

    });

    $('#fontColor').colorPicker({
        onColorChange : function (id, newColor) {
            setSelectionFontColor(newColor);
        }
    });
    $('#lineColor').colorPicker({
        onColorChange : function (id, newColor) {
            setSelectionLineColor(newColor);
        }
    });
    $('#rectBackground').colorPicker({
        onColorChange : function (id, newColor) {
            setSelectionBackgroundColor(newColor);
        }
    });
    $('body').on('keydown', function (evt) {
        console.log(evt.keyCode);
        if (evt.keyCode && evt.keyCode === 13) {        //enter
            appendSelectionBrother();
        } else if (evt.keyCode && evt.keyCode === 9) { //tab
            evt.preventDefault();
            appendSelectionChild();
        } else if (evt.keyCode && evt.keyCode === 45) { //ins
            appendSelectionChild();
        } else if (evt.keyCode && evt.keyCode === 46) { //del
            removeSeletion();
        } else if (evt.keyCode && evt.keyCode === 113) {//F2
            editSelection();
        } else if (evt.keyCode && evt.keyCode === 37) { //left
            // move to left subject
        } else if (evt.keyCode && evt.keyCode === 38) { //up
            // move to up subject
        } else if (evt.keyCode && evt.keyCode === 39) { //right
            // move to right subject
        } else if (evt.keyCode && evt.keyCode === 40) { //down
            // move to down subject
        } else if (evt.keyCode && evt.keyCode === 66 && evt.ctrlKey) { //ctrl+b
            changeSelectionFontWeight();
        } else if (evt.keyCode && evt.keyCode === 73 && evt.ctrlKey) { //ctrl+i
            changeSelectionFontStyle();
        } else if (evt.keyCode && evt.keyCode === 89 && evt.ctrlKey) { //ctrl+y
            redo();
        } else if (evt.keyCode && evt.keyCode === 90 && evt.ctrlKey) { //ctrl+z
            undo();
        }
    });
    $('body').on('click', function () {
        $('.context-menu').hide();
    })
    $('.painter').contextmenu(function (evt) {
        evt.preventDefault();
    });
    $('.btn-font-color').click(clickFontColor);
    $('.btn-line-color').click(clickLine);
    $('.btn-fill-color').click(clickBackground);
    diagramCtrl.bind('contextmenu', function (e) {
        //show context menu
        if (e.target.getModel() instanceof MindNode) {
            console.log(e.target.getModel());
            e.preventDefault();
            showSelectionContextMenu(calcMenuX(e.pageX), calcMenuY(e.pageY));
        }
    });
    diagramCtrl.bind('dblclick', function (e) {
        //maybe open text editor
        editSelection();
    });

</script>
</html>
